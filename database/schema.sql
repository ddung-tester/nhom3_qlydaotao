
-- CHỈ bảng "User" viết hoa và dùng dấu "
-- =========================================================

-- DROP theo thứ tự phụ thuộc
DROP TABLE IF EXISTS XepLich CASCADE;
DROP TABLE IF EXISTS PhongHoc CASCADE;
DROP TABLE IF EXISTS BuoiHoc CASCADE;
DROP TABLE IF EXISTS PhanCong CASCADE;
DROP TABLE IF EXISTS DiemThi CASCADE;
DROP TABLE IF EXISTS DangKyKhoa CASCADE;
DROP TABLE IF EXISTS LopMonHoc CASCADE;
DROP TABLE IF EXISTS KhoaDaoTao CASCADE;
DROP TABLE IF EXISTS MonHoc CASCADE;
DROP TABLE IF EXISTS KyHoc CASCADE;
DROP TABLE IF EXISTS ChuongTrinh CASCADE;
DROP TABLE IF EXISTS NhanVien CASCADE;
DROP TABLE IF EXISTS GiangVien CASCADE;
DROP TABLE IF EXISTS HocVien CASCADE;
DROP TABLE IF EXISTS User_SDT CASCADE;
DROP TABLE IF EXISTS "User" CASCADE;

-- 4.4.1. "User"
CREATE TABLE "User" (
  USER_ID     INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  HoTen       VARCHAR(255) NOT NULL,
  NgaySinh    DATE,
  Email       VARCHAR(255) UNIQUE
);

-- 4.4.2. User_SDT
CREATE TABLE User_SDT (
  USER_ID INT NOT NULL,
  SDT     VARCHAR(20) NOT NULL,
  PRIMARY KEY (USER_ID, SDT),
  FOREIGN KEY (USER_ID) REFERENCES "User"(USER_ID) ON DELETE CASCADE
);

-- 4.4.3. HocVien
CREATE TABLE HocVien (
  USER_ID INT PRIMARY KEY,
  DiaChi  VARCHAR(255),
  FOREIGN KEY (USER_ID) REFERENCES "User"(USER_ID) ON DELETE CASCADE
);

-- 4.4.4. GiangVien
CREATE TABLE GiangVien (
  USER_ID   INT PRIMARY KEY,
  ChuyenMon VARCHAR(255),
  FOREIGN KEY (USER_ID) REFERENCES "User"(USER_ID) ON DELETE CASCADE
);

-- 4.4.5. NhanVien (khóa ngoại tự tham chiếu, QuanLy_ID NOT NULL)
CREATE TABLE NhanVien (
  USER_ID     INT PRIMARY KEY,
  NgayVaoLam  DATE,
  QuanLy_ID   INT NOT NULL,
  FOREIGN KEY (USER_ID) REFERENCES "User"(USER_ID) ON DELETE CASCADE,
  FOREIGN KEY (QuanLy_ID) REFERENCES NhanVien(USER_ID) ON DELETE RESTRICT
);

-- 4.4.6. ChuongTrinh
CREATE TABLE ChuongTrinh (
  CT_ID         INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  TenCT         VARCHAR(255) NOT NULL,
  MoTa          VARCHAR(500),
  NV_QuanLy_ID  INT NOT NULL,
  FOREIGN KEY (NV_QuanLy_ID) REFERENCES NhanVien(USER_ID) ON DELETE RESTRICT
);

-- 4.4.7. MonHoc
CREATE TABLE MonHoc (
  MH_MA   VARCHAR(50) PRIMARY KEY,
  CT_ID   INT NOT NULL,
  TenMH   VARCHAR(255) NOT NULL,
  SoGio   INT NOT NULL CHECK (SoGio > 0),
  FOREIGN KEY (CT_ID) REFERENCES ChuongTrinh(CT_ID) ON DELETE RESTRICT,
  CONSTRAINT uq_mh_ten_trong_ct UNIQUE (CT_ID, TenMH)
);

-- 4.4.8. KyHoc
CREATE TABLE KyHoc (
  KY_ID        INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  HocKy        VARCHAR(20) NOT NULL,
  Nam          INT NOT NULL CHECK (Nam >= 2000),
  NgayBatDau   DATE,
  NgayKetThuc  DATE,
  CONSTRAINT uq_kyhoc UNIQUE (HocKy, Nam),
  CONSTRAINT chk_ngay_kyhoc CHECK (
    NgayBatDau IS NULL OR NgayKetThuc IS NULL OR NgayBatDau <= NgayKetThuc
  )
);

-- 4.4.9. KhoaDaoTao
CREATE TABLE KhoaDaoTao (
  KDT_ID        INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  CT_ID         INT NOT NULL,
  KY_ID         INT NOT NULL,
  TenKhoa       VARCHAR(255) NOT NULL,
  NgayKhaiGiang DATE,
  FOREIGN KEY (CT_ID) REFERENCES ChuongTrinh(CT_ID) ON DELETE RESTRICT,
  FOREIGN KEY (KY_ID) REFERENCES KyHoc(KY_ID) ON DELETE RESTRICT,
  CONSTRAINT uq_kdt_ct_ky UNIQUE (CT_ID, KY_ID)
);

-- 4.4.10. LopMonHoc
CREATE TABLE LopMonHoc (
  LopMH_ID INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  KDT_ID   INT NOT NULL,
  MH_MA    VARCHAR(50) NOT NULL,
  FOREIGN KEY (KDT_ID) REFERENCES KhoaDaoTao(KDT_ID) ON DELETE CASCADE,
  FOREIGN KEY (MH_MA) REFERENCES MonHoc(MH_MA) ON DELETE RESTRICT,
  CONSTRAINT uq_lopmh_kdt_mh UNIQUE (KDT_ID, MH_MA)
);

-- 4.4.11. DangKyKhoa
CREATE TABLE DangKyKhoa (
  HV_ID     INT NOT NULL,
  KDT_ID    INT NOT NULL,
  NgayDK    DATE NOT NULL DEFAULT CURRENT_DATE,
  TrangThai VARCHAR(30) NOT NULL DEFAULT 'DANG_HOC',
  PRIMARY KEY (HV_ID, KDT_ID),
  FOREIGN KEY (HV_ID) REFERENCES HocVien(USER_ID) ON DELETE CASCADE,
  FOREIGN KEY (KDT_ID) REFERENCES KhoaDaoTao(KDT_ID) ON DELETE CASCADE,
  CONSTRAINT chk_trangthai_dkk CHECK (TrangThai IN ('DANG_HOC','HOAN_THANH','HUY'))
);

-- 4.4.12. DiemThi
CREATE TABLE DiemThi (
  HV_ID     INT NOT NULL,
  LopMH_ID  INT NOT NULL,
  LanThi    INT NOT NULL CHECK (LanThi >= 1),
  Diem      NUMERIC(4,2) CHECK (Diem IS NULL OR (Diem >= 0 AND Diem <= 10)),
  NgayThi   DATE,
  PRIMARY KEY (HV_ID, LopMH_ID, LanThi),
  FOREIGN KEY (HV_ID) REFERENCES HocVien(USER_ID) ON DELETE CASCADE,
  FOREIGN KEY (LopMH_ID) REFERENCES LopMonHoc(LopMH_ID) ON DELETE CASCADE
);

-- 4.4.13. PhanCong
CREATE TABLE PhanCong (
  PC_ID    INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  GV_ID    INT NOT NULL,
  LopMH_ID INT NOT NULL,
  VaiTro   VARCHAR(20) NOT NULL,
  FOREIGN KEY (GV_ID) REFERENCES GiangVien(USER_ID) ON DELETE CASCADE,
  FOREIGN KEY (LopMH_ID) REFERENCES LopMonHoc(LopMH_ID) ON DELETE CASCADE,
  CONSTRAINT chk_vaitro CHECK (VaiTro IN ('GIANGVIEN','TROGIANG')),
  CONSTRAINT uq_pc UNIQUE (GV_ID, LopMH_ID, VaiTro)
);

-- 4.4.14. BuoiHoc
CREATE TABLE BuoiHoc (
  BuoiHoc_ID INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  NgayHoc    DATE NOT NULL,
  GioBD      TIME NOT NULL,
  GioKt      TIME NOT NULL,
  CONSTRAINT chk_2h CHECK (GioKt = (GioBD + INTERVAL '2 hours')::time)
);

-- 4.4.15. PhongHoc
CREATE TABLE PhongHoc (
  PH_ID    INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  DiaDiem  VARCHAR(255),
  MaPhong  VARCHAR(50) NOT NULL,
  CONSTRAINT uq_phong UNIQUE (DiaDiem, MaPhong)
);

-- 4.4.16. XepLich
CREATE TABLE XepLich (
  BuoiHoc_ID INT PRIMARY KEY,
  LopMH_ID   INT NOT NULL,
  PH_ID      INT NOT NULL,
  FOREIGN KEY (BuoiHoc_ID) REFERENCES BuoiHoc(BuoiHoc_ID) ON DELETE CASCADE,
  FOREIGN KEY (LopMH_ID) REFERENCES LopMonHoc(LopMH_ID) ON DELETE CASCADE,
  FOREIGN KEY (PH_ID) REFERENCES PhongHoc(PH_ID) ON DELETE RESTRICT
);
